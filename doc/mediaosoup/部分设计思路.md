
## EA的分配策略
### 说明
- EA的管理中心是所有的EC，每个EC都维护了当前集群中的所有的EA的列表
- EA的分配时间点为EC上的Room创建，也就是当房间第一个用户进入时
- EA的分配策略分成两种情况 非级联模式 和级联模式
#### 非级联模式
- 在非级联模式，一个房间的所有用户都在一个EA的相同SFU上，
- 具体分配到哪个EA上，默认的策略是根据每个EA的房间数量，最少的优先分配
#### 级联模式
- 级联模式是为了应对 用户分布地域差异，可能会导致延迟较大的问题
- 在级联模式下，EC总是为用户分配一个网路距离最近的EA
- 级联模式下，每个用户所在的EA可能都是不一样的，但是每个EA只会为一个房间分配同一个SFU，
    也就是说如果一个两个用户分配到了相同的EA，那么他们肯定在同一个SFU上
- 房间级联模式的开启是在创建房间时传入参数eapolicy 设置房间是否开启 SFU级联
### EA网络波动对服务的影响
#### 说明 
- 在实际的情况下，网络的波动，可能会造成EC对EA的保活检测超时，在真正把EA从EC的agents删除之前，EA可能会参与服务，
这种情况下被分配的EA实际可能已经失联，会发生很多未知的错误 
#### ROOM-BEST模式
- 在ROOM-BEST模式下，是根据每个EA的负载最小分配的，在计算时还需要考虑每个EA是否处于，断连容忍状态，处于这种状态的EA，不应该参与服务
#### TTL-BEST模式
- TTL-BEST模式由于会需要测试PING值，对于断连的EA本身就不会收到回复，自然不会参与服务


#### 如何判定用户和EA之间的网络距离
- EC作为网关，存储了客户端的地址信息，它将信息同步给EA，每个EA通过计算PING值，反馈到EC

## EC的分配策略
### 说明
- EC的管理中心是NUVE，EC在启动后到NUVE注册
- 当用户申请token时NUVE为用户分配一个EC，默认的分配策略是随机
- 同一个房间的用户一定会被分配到同一个EC上

## SFU的分配策略
### 说明
- 这里说的SFU指的是mediasoup的worker子进程，程序启动后会根据节点服务器的CPU数量启动对应数量的SFU，
    以实现对资源的最大化利用
- EA维护当前节点的SFU列表，当新的逻辑房间创建时,EC请求到EA为房间分配一个SFU，EA的策略是循环分配，保证每个SFU上的房间数量都是
    相同的，但不能保证负载相同



## worker进程为什么要根据核数去创建
### 说明
- mediasouo-worker子进程为单线程，在实际部署时EA由于对端口的需求量大，往往单独部署，
  为了对该机器资源的最大化利用，所以启动的worker子进程和CPU的数量相同

## EC<--->EA如何保证数据的同步 
### 说明 
- 这里说的同步，主要指的是 room、client 状态同步 
### room
- room在EC的创建时机是第一个用户请求进入房间时
- room在EA的创建时机是ec-room创建时，每个房间都需要关联的一个或者是多个EA，当创建房间时首先就会创建ea-room

- room在EC的消除时机是当最后一个用户退出时，
- room在EA的消除也是在最后一个用户退出时，EC在用户退出时会广播消息，通知EA删除对应的用户，当发现房间内用户为空，则删除房间

### client
- client在EC的创建时机为token事件处理后
- client在EA的创建时机为处理用户的 getRouterRtpCapabilities 事件


## 限流
### NUVE限流
- 所有的客户端在连接进入系统的第一步就是到NUVE获取token，所谓NUVE的HTTP接口是作为第一级限流
- NUVE的限流分为两部分，全局的QPS 和针对单个IP地址QPS限制
#### 全局QPS
- 全局QPS限制整个NUVE集群对外的并发数量，默认数值为1000，超过10000部分直接回复错误
- 全局QPS可以开启队列，当开启队列时，对于超出1000的部分入队列
#### 单个用户QPS
- 单个用户QPS限制单个IP地址在单位时间内的请求次数，超过直接回复错误

### EC限流
- EC作为网关，针对EC的限流时本地的，也就是我们只限制单个EC的接入QPS,因为用户来连接EC时NUVE已经将该用户和该EC绑定，
  为了避免EC之间的相互影响，每个EC的QPS计数都是存储在本地
  


